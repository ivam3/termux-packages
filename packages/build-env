#!/usr/bin/bash

[[ $# -eq 0 ]] && { echo -en >&2 "\e[31mmissing argument, type $(basename $0) -h for help\e[0m"; exit 1;}

usage(){
	echo -en """
usage $(basename $0) <options>

OPTIONS\t|DESCRIPTIONS
n\tpackage name
v\tpackage version
a\tarchitecture
p\tsupport page
h\tshow this menu
"""
	exit 0
}

while getopts n:v:a:d:p:s:i:h opts; do
	case $opts in 
		n) pkgName=$OPTARG 
			if [[ -d $pkgName ]]
			then
				echo -en "\e[31mPackage $pkgName already exists\e[0m"
				exit 1
			fi
			;;
		v) pkgv=$OPTARG ;;
		a) arch=$OPTARG ;;
		p) page=$OPTARG ;;
		h) usage ;;
		*) usage ;;
	esac
done

mkdir -p $pkgName
#MANIFIEST
cat <<- CONF > $pkgName/manifiest.json
{
  "name": "$pkgName",
  "version": "$pkgv",
  "arch": "$arch",
  "homepage": "https://$page",
  "maintainer": "Ivam3 <https://t.me/Ivam3_Bot>",
  "depends": [""],
  "suggests": [""],
  "description": "",
  "files" :{
    "$pkgName-installer": "bin/$pkgName-installer",
    "$pkgName": "bin/$pkgName",
    "fixer": "bin/fixer"
	}
}
CONF

#EXECUTABLE
cat <<- CONF > $pkgName/$pkgName
#!/data/data/com.termux/files/usr/bin/bash

# COLORS
W="\\e[0m"
R="\\e[31m"
G="\\e[32m"
Y="\\e[33m"
B="\\e[34m"
if [[ -d \${PREFIX}/share/\$(basename \$0) ]]
then
  pushd \${PREFIX}/share/\$(basename \$0) >/dev/null
  \$(command -v ruby) \$(basename \$0).rb \${@:1}
else
  echo -en "\$R(_➤) ERROR :\$W \$(basename \$0) PATH missing ...\$Y Aborting.\$W"
  exit 1
fi
####::: REPORT ISSUES AT https://t.me/Ivam3_Bot :::####
CONF

#INSTALLER
cat <<- CONF > $pkgName/$pkgName-installer
#!/data/data/com.termux/files/usr/bin/bash
IFS=$'\\n\\t'

exit 0
####::: REPORT ISSUES AT https://t.me/Ivam3_Bot :::####
CONF

#FIXER 
cat <<- CONF > $pkgName/fixer
#!/data/data/com.termux/file/usr/bin/bash
if [[ ! \$(command -v lolcat) ]] &>/dev/null 
then
  if [[ ! \$(command -v ruby) ]] &>/dev/null 
  then
    apt install ruby -y
  fi
  gem install lolcat
fi

if [[ ! \$(command -v curl) ]] &>/dev/null 
then
  apt install curl -y
fi
bash <(curl -fsSL https://raw.githubusercontent.com/ivam3/i-Haklab/master/.set/bin/fixer) \${@:1}

####::: REPORT ISSUES AT https://t.me/Ivam3_Bot :::####
CONF

#PREINST
cat <<- CONF > $pkgName/preinst
#!/data/data/com.termux/files/usr/bin/bash
if [[ \$(id -u) -eq 0 ]]
then
  echo -en "\\e[31m(_➤)\\e[0m You need to be a common user"
  exit 1
else
  echo "Preparing enviroment ..."
  if [[ -d \${PREFIX}/share/$pkgName ]]
  then
    rm -rf \${PREFIX}/share/$pkgName
  fi
fi
####::: REPORT ISSUES AT https://t.me/Ivam3_Bot :::####
CONF

#POSTINST
cat <<- CONF > $pkgName/postinst
#!/data/data/com.termux/files/usr/bin/bash
if [[ -e \$PREFIX/bin/$pkgName-installer ]]; then
  bash \${PREFIX}/bin/$pkgName-installer
  rm -rf \${PREFIX}/bin/$pkgName-installer
fi
echo "[*] $pkgName installation finished."
echo "[!] For help going to https://t.me/Ivam3_Bot."
echo "[*] @Ivam3: thank you for use my package."
####::: REPORT ISSUES AT https://t.me/Ivam3_Bot :::####
CONF

#PRERM
cat <<- CONF > $pkgName/prerm
#!/data/data/com.termux/files/usr/bin/bash
if [[ -d \${PREFIX}/share/$pkgName ]]; then
  rm -rf \${PREFIX}/share/$pkgName
fi
####::: REPORT ISSUES AT https://t.me/Ivam3_Bot :::####
CONF

#POSTRM
cat <<- CONF > $pkgName/postrm
#!/data/data/com.termux/files/usr/bin/bash
CONF

