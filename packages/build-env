#!/usr/bin/bash

[[ $# -eq 0 ]] && { echo -en >&2 "\e[31mmissing argument, type $(basename $0) -h for help\e[0m"; exit 1;}

usage(){
	echo -en """
usage $(basename $0) <options>

OPTIONS\t|DESCRIPTIONS
n\tpackage name
v\tpackage version
a\tarchitecture
p\tsupport page
h\tshow this menu
"""
	exit 0
}

while getopts n:v:a:d:p:s:i:h opts; do
	case $opts in 
		n) pkgName=$OPTARG 
			if [[ -d $pkgName ]]
			then
				echo -en "\e[31mPackage $pkgName already exists\e[0m"
				exit 1
			fi
			;;
		v) pkgv=$OPTARG ;;
		a) arch=$OPTARG ;;
		p) page=$OPTARG ;;
		h) usage ;;
		*) usage ;;
	esac
done

mkdir -p $pkgName/img
#MANIFIEST
cat <<- CONF > $pkgName/manifiest.json
{
  "name": "$pkgName",
  "version": "$pkgv",
  "arch": "$arch",
  "homepage": "https://$page",
  "maintainer": "Ivam3 <https://t.me/Ivam3_Bot>",
  "depends": ["git"],
  "suggests": ["i-haklab"],
  "description": "",
  "files" :{
    "$pkgName": "bin/$pkgName",
    "img/$pkgName.png": "${PREFIX}/share/applications/$pkgName/img/$pkgName.png",
    "$pkgName.desktop": "${PREFIX}/share/applications/$pkgName/$pkgName.desktop"
  }
}
CONF

#EXECUTABLE
cat <<- CONF > $pkgName/$pkgName
#!/data/data/com.termux/files/usr/bin/bash
# COLORS
W="\\e[0m"
R="\\e[31m"
G="\\e[32m"
Y="\\e[33m"
B="\\e[34m"
if [[ -d \${HOME}/.local/share/$pkgName ]]
then
  cd \${HOME}/.local/share/\$(basename \$0) >/dev/null
  \$(command -v python) \$(basename \$0).py \${@:1}
else
  echo -en \$R"E:\$W \$(basename \$0) PATH missing ...\$Y Aborting.\$W"
  exit 1
fi
####::: REPORT ISSUES AT https://t.me/Ivam3_Bot :::####
CONF

#DESKTOP
cat <<- CONF > $pkgName/$pkgName.desktop
[Desktop Entry]
Name=$pkgName
GenericName=$pkgName
Comment=
Comment[es]=
Version=$pkgv
Exec=$pkgName
Icon=/data/data/com.termux/files/usr/share/applications/$pkgName/img/$pkgName.png
Terminal=false
Type=Application
Categories=System
X-Desktop-File-Install-Version=$pkgv
CONF

#PREINST
cat <<- CONF > $pkgName/preinst
#!/data/data/com.termux/files/usr/bin/bash
if [[ \$(id -u) -eq 0 ]]
then
  echo -en "\\e[31mE:\\e[0m You need to be a common user\\n"
  exit 1
else
  echo "Preparing enviroment ..."
  if [[ -d \${HOME}/.local/share/$pkgName ]]
  then
    rm -rf \${HOME}/.local/share/$pkgName
  else
    mkdir -p \${HOME}/.local/share 2>/dev/null
  fi
fi
####::: REPORT ISSUES AT https://t.me/Ivam3_Bot :::####
CONF

#POSTINST
cat <<- CONF > $pkgName/postinst
#!/data/data/com.termux/files/usr/bin/bash
IFS=$'\\n\\t'
echo "Cloning repository ..."
git clone --quiet https://$page \${HOME}/.local/share/$pkgName
[[ -d \${HOME}/.local/share/$pkgName ]] && {
  echo "Installing requirements ...";
  chmod 751 -R \${HOME}/.local/share/$pkgName;
  python -m pip --no-color --quiet --no-cache-dir install -r \${HOME}/.local/share/$pkgName/requirements.txt; 
} || {
  echo -en "\e[31mE:\e[0m $pkgName directory missing ... \e[33mAborting.\e[0m\n";
}
wget --tries=20 --quiet https://raw.githubusercontent.com/ivam3/i-Haklab/master/.deb/home/.local/bin/fixer -O /data/data/com.termux/files/usr/bin/fixer
chmod 750 /data/data/com.termux/files/usr/bin/fixer
echo "[*] $pkgName installation finished."
echo "[*] Run '$pkgName' to execute it."
echo "[*] Run 'fixer' to fix any posible issue."
echo "[!] For help going to https://t.me/Ivam3_Bot."
echo "[*] @Ivam3: thank you for use my package."
####::: REPORT ISSUES AT https://t.me/Ivam3_Bot :::####
CONF

#PRERM
cat <<- CONF > $pkgName/prerm
#!/data/data/com.termux/files/usr/bin/bash
if [[ -d \${HOME}/.local/share/$pkgName ]]; then
  rm -rf \${HOME}/.local/share/$pkgName
fi
python -m pip --no-color --quiet uninstall -r \${HOME}/.local/share/$pkgName/requirements.txt; 

####::: REPORT ISSUES AT https://t.me/Ivam3_Bot :::####
CONF

#POSTRM
cat <<- CONF > $pkgName/postrm
#!/data/data/com.termux/files/usr/bin/bash
echo "Done. Package '$pkgName' removed."
CONF

