#!/usr/bin/bash
# Coded on Agust 2019 by Ivam3 and upgraded on July 2021
#
SCRIPT_NAME=$(basename "$0")
BEEF_PATH="$PREFIX/opt/beef"
MSF_PATH="$PREFIX/opt/metasploit-framework"
RUBYv=$(ls ${PREFIX}/lib/ruby|grep -m 1 '[0-9].[0-9].[0-9]')
LINUXANDROID=$(find ${PREFIX}/lib/ruby/$RUBYv -iname "bigdecimal.so"|awk -F "/" '{print $10}'
R='\e[31m'
G='\e[32m'
Y='\e[33m'
W='\e[0m'
STDERR(){ echo -en >&2 $R"ERROR:$W BeeF is not installed ...$Y Aborting.$W";exit;}

#::: Fix ruby bigdecimal extensions linking error :::#
export LD_PRELOAD="$LD_PRELOAD:$PREFIX/lib/ruby/$RUBYv/$LINUXANDROID/bigdecimal.so"
[[ -d $BEEF_PATH ]] && {
	printf $Y"BEEF:$W running metasploit's RPC server."
	cd $BEEF_PATH
	echo"load msgrpc ServerHost=127.0.0.1 ServerPort=55552 User=msf Pass='abc123' SSL=y" > $MSF_PATH/beef.rc
	msfconsole -q -r $MSF_PATH/beef.rc &>/dev/null &;ps=$(echo $!)
	until [[ $(nmap -p55552 127.0.0.1|grep "55552"|awk -F " " '{print $2}') = open ]]
	do
		continue
	done
	exec ruby $BEEF_PATH/$SCRIPT_NAME
	kill -TERM $ps;disown $ps
} || {
	STDERR;
}

#		@Ivam3
