#!/data/data/com.termux/files/usr/bin/bash
METASPLOIT_PATH="${PREFIX}/opt/metasploit-framework"
RUBYv=$(ls ${PREFIX}/lib/ruby |grep -m 1 '[0-9].[0-9].[0-9]')
LINUXANDROID=$(find ${PREFIX}/lib/ruby/$RUBYv -iname "bigdecimal.so"|awk -F "/" '{print $10}')
export LD_PRELOAD="$LD_PRELOAD:${PREFIX}/lib/ruby/$RUBYv/$LINUXANDROID/bigdecimal.so"

case "$(basename $0)" in
  msfconsole)
    mkdir -p ${PREFIX}/var/lib/postgresql
    initdb "${PREFIX}/var/lib/postgresql" >/dev/null 2>/dev/null
    if ! pg_ctl -D "${PREFIX}/var/lib/postgresql" status >/dev/null 2>/dev/null;then
      pg_ctl -D "${PREFIX}/var/lib/postgresql" start --silent >/dev/null 2>/dev/null
    fi
    [[ -z "$(psql postgres -tAc "SELECT 1 FROM pg_roles WHERE rolname='msf'")" ]] && { createuser msf;}
    [[ -z "$(psql -l | grep msf_database)" ]] && {
      createdb msf_database
      pg_ctl -D ${PREFIX}/var/lib/postgresql restart
      psql -d msf_database -c "ALTER DATABASE msf_database OWNER TO msf;ALTER USER msf WITH PASSWORD ' ';"
    }
    exec ruby "$METASPLOIT_PATH/$(basename $0)" "$@"
    ;;
  msfd|msfdb|msfrpc|msfrpcd|msfvenom)
    [[ -e ${HOME}/.local/share/apktool/framework/1.apk ]] && { rm ${HOME}/.local/share/apktool/framework/1.apk;}
    exec ruby "$METASPLOIT_PATH/$(basename $0)" "$@"
    ;;
  *)
    echo "[!] Unknown Metasploit command '$(basename $0)'.";exit 1
    ;;
esac
