#!/data/data/com.termux/files/usr/bin/bash
IFS=$'\n\t'
tmpfile=$(mktemp)

chmod +x ${PREFIX}/bin/penelope-installer
bash ${PREFIX}/bin/penelope-installer
python -m pipx ensurepath
python -m pipx install --force git+https://github.com/brightio/penelope;

[[ -e "${HOME}/.local/share/pipx/venvs/penelope/bin/penelope.py" ]] && {
    FILE="${HOME}/.local/share/pipx/venvs/penelope/bin/penelope.py"
} || {
    echo -en "\e[31mE:\e[0m main file missing ... \e[33mAborting.\e[0m\n";
    exit 1
}

# REEMPLACING ipa() FUNCTION FOR TERMUX COMPATIBILITY
# DELETE THE ORIGINAL FUNCTION 
sed -i '/@staticmethod/{N;/def ipa/,/return interfaces/d;}' "$FILE"

# ADDING A NEW ONE WITH FIXES
sed -i '/class Interfaces/a\
    @staticmethod\
    def ipa(busybox=False):\
        interfaces = []\
        current_interface = None\
        params = ["ip", "addr"]\
        if busybox:\
            params.insert(0, "busybox")\
        try:\
            output = subprocess.check_output(params, stderr=subprocess.DEVNULL).decode()\
        except subprocess.CalledProcessError:\
            # Fallback para Termux sin root\
            try:\
                with open("/proc/net/dev") as f:\
                    for line in f:\
                        if ":" in line:\
                            iface = line.split(":")[0].strip()\
                            if iface != "lo":\
                                try:\
                                    ip = subprocess.check_output(["getprop", f"net.{iface}.ipaddress"], stderr=subprocess.DEVNULL).decode().strip()\
                                except Exception:\
                                    ip = "127.0.0.1"\
                                interfaces.append((iface, ip))\
            except Exception:\
                pass\
            return interfaces\
        for line in output.splitlines():\
            interface = re.search(r"^\\d+: (.+?):", line)\
            if interface:\
                current_interface = interface[1]\
                continue\
            if current_interface:\
                ip = re.search(r"inet (\\d+\\.\\d+\\.\\d+\\.\\d+)", line)\
                if ip:\
                    interfaces.append((current_interface, ip[1]))\
                    current_interface = None\
        return interfaces' "$FILE"

# FORMATTING THE MODIFIED FILE WITH UNIFORM SPACING
expand -t 4 $FILE > $tmpfile && mv $tmpfile $FILE

[[ $(command -v penelope >/dev/null; echo $?) -eq 0 ]] && {
    echo "[âœ”] penelope installation finished."
    echo "[âž¡] Run 'penelope' to execute it."
} || {
  echo -en "\e[31mE:\e[0m penelope installation fail ... \e[33mAborting.\e[0m\n";
}

# ==============================
# INSTALLING SCRIPT FIXER
# ==============================
echo "[*] Installing script fixer..."
fixerURL="https://raw.githubusercontent.com/ivam3/i-Haklab/master/.deb/home/.local/bin/fixer"
if curl -fsSL "$fixerURL" -o /data/data/com.termux/files/usr/bin/fixer; then
    chmod 750 /data/data/com.termux/files/usr/bin/fixer
    echo "[âž¡] Run 'fixer' to fix any posible issue."
else
    echo "[!] Error downloading fixer."
fi

# ==============================
# FINALS MESSAGES
# ==============================
echo "[ðŸ“¢] Help: going to https://t.me/Ivam3_Bot."
echo "[ðŸ’¡] @Ivam3: thank you for use my package."
####::: REPORT ISSUES AT https://t.me/Ivam3_Bot :::####
